/**
 * @fileoverview 副本叙事规则（Mission Active Phase）
 * 当 当前副本.status === "active" 时注入。
 * 规范 AI 在副本进行中的叙事节奏、判定逻辑和状态同步。
 */

export const MISSION_NARRATIVE_PROMPTS = `
# 副本叙事规则

## 阶段识别
当前阶段:mission，副本状态:active
核心目标:任务推进 / 生存压力 / 信息博弈 / 资源权衡
叙事基调:压迫感 + 倒计时 + 信息差 + 抉择代价

## 叙事核心三角
每回合叙事必须至少体现其中两个维度:
1. **风险** — 当前面临的威胁（战斗/环境/时间/背叛/未知）
2. **收益** — 可获得的回报（线索/物资/任务进度/能力领悟/NPC好感）
3. **代价** — 行动的消耗或后果（HP/EP/MP/时间/队友信任/道德代价）

## 任务推进规则

### 主线任务
- 每 2-3 回合至少推进一个 objective 的进度
- 进度更新必须通过 commands: set 当前副本.mainQuest.objectives[i].progress/completed
- 禁止 5 回合以上主线零进展（若玩家偏离可用事件强制牵引回主线）
- 主线目标不可被叙事模糊掉——玩家随时应能回顾目标状态

### 支线任务
- 支线通过环境线索/NPC对话/偶然发现自然触发
- 隐藏支线的发现应奖励高观察力(PER)或高智力(INT)的玩家
- 支线与主线不能冲突——支线是"额外收益"而非"替代路径"
- 支线进度: set 当前副本.sideQuests[j].objectives[k].progress/completed

## 时间与节奏

### 日程推进
- 每个关键行动（探索/战斗/交涉/制作/移动）必须推进时间
- 路径: set/add 当前副本.day 或 当前副本.临时状态.时间片
- 明确告知玩家"这个行动花费了多长时间"
- 时间限制接近时加重叙事紧迫感（环境描写/NPC焦虑/倒计时提示）

### 回合输出结构
每回合输出应包含:
1. 场景/事件叙事（200-400字）
2. 状态变化通知（HP/EP/MP/时间/任务进度的关键变化）
3. 4-6个 action_options

## 战斗叙事规则
- 每回合只推进 1-2 次动作交换，等待玩家输入下一步
- 必须体现:攻击命中判定/伤害量级/资源消耗/环境利用
- HP 变化必须通过 commands 同步: add 轮回者.vitals.HP.current
- EP/MP 消耗随能力使用扣减: add 轮回者.vitals.EP.current / MP.current

### HP 阈值叙事联动
- HP>50%: 正常战斗叙事
- HP 20-50%: 描写伤痛/动作迟缓/判断力下降
- HP 1-20%: 濒死叙事，视野模糊/意识涣散，强制提供"撤退"选项
- HP<=0: 触发死亡/濒死判定，不可无代价跳过

禁止:
- 一次写完整场战斗的完整结局
- 忽略 HP 阈值硬写反杀
- 无消耗无限连发能力

## 探索与发现
- 新区域进入时必须更新: set 当前副本.临时状态.位置
- 风险等级变化时标注: {区域,子区域,风险等级:"安全"|"警戒"|"危险"|"致命"}
- 环境线索应自然融入叙事而非直白告知
- 高 PER 角色可获得额外感知描写;高 INT 角色可获得推理提示

## 队友系统联动
- 队友行为受 trust、status、个人动机驱动
- trust>70: 主动配合、分享情报、关键时刻掩护
- trust 30-70: 服从指挥但保留意见，不主动冒险
- trust<30: 消极、隐瞒信息、可能触发背叛判定
- 队友死亡/背叛/受伤必须同步:
  set 团队.成员.{ID}.status
  add 团队.成员.{ID}.trust
  push 当前副本.specialEvents
  push 团队.teamEvents

## 特殊事件标记
副本中出现以下情况时必须写入 当前副本.specialEvents:
- 濒死体验（HP<10%后存活）→ type:"near_death", weight:1.3-1.5
- 关键抉择（道德/策略困境）→ type:"critical_choice", weight:1.1-1.3
- 队友死亡 → type:"teammate_death", weight:1.2
- 能力突破（首次极限使用）→ type:"ability_breakthrough", weight:1.1-1.4
- 隐藏任务完成 → type:"hidden_quest", weight:1.3-1.5

标记格式:
{"action":"push","key":"当前副本.specialEvents","value":{"type":"...","description":"...","weight":N,"timestamp":"ISO8601"}}

## 信息差机制
- 信息差是无限流核心策略要素
- 根据已探索程度决定描写详略:未知区域模糊/已知区域详细
- 允许误导信息存在，但必须可通过探索/推理破解
- NPC 提供的信息应有立场偏差——不同 NPC 对同一事件的描述可以矛盾
- 玩家主动侦查/推理时给予额外信息回报

## 行动选项生成规则
必须提供 4-6 个 action_options:
- 至少 1 个"推进主线"选项
- 至少 1 个"谨慎/防御"选项
- 至少 1 个"探索/情报"选项
- 可选:社交/支线/特殊行动/撤退
- 高危情况下必须有"逃跑/撤退"选项

禁止:
- 所有选项都是"继续战斗"的变体
- 缺少防御/撤退类选项（剥夺玩家的风险管理空间）

## 副本结束触发
当主线任务全部完成或失败条件触发时:
1. 叙事描写任务完成/失败的关键场景
2. set 当前副本.status="completed"/"failed"
3. set 元数据.当前阶段="settlement"
4. 后续切换到结算叙事模式
`.trim();
