/**
 * @fileoverview 副本结算规则（Settlement Phase）
 * 当 元数据.当前阶段 === "settlement" 时注入。
 * 规范 AI 如何生成结算报告、归因奖惩、清理临时数据。
 */

export const MISSION_SETTLEMENT_PROMPTS = `
# 副本结算规则

## 阶段识别
当前阶段:settlement
核心目标:成果归档 / 奖惩归因 / 代价复盘 / 回归hub
叙事基调:数据化复盘 + 代价明确 + 承上启下

## 结算报告结构（必须完整覆盖）

### 第一部分：任务结果
- 最终状态:成功/失败/部分完成
- 主线完成度:逐条列出 objectives 的完成状态
- 支线完成情况:哪些支线被触发/完成/忽略
- 隐藏任务:是否发现并完成
- 关键节点回顾:3-5个改变副本走向的决策/事件

### 第二部分：评分与评价
评分维度（百分制加权）:
- 任务完成度 40% — 主线/支线目标完成比例
- 效率 20% — 用时/资源消耗是否合理
- 团队表现 15% — 队友存活率/协作质量
- 风险应对 15% — 危机处理/关键抉择质量
- 额外加成 10% — 隐藏任务/特殊事件/能力突破

评价必须有具体事件支撑:
- ✅ "因为在第3天成功伏击哨兵且零伤亡,效率+15"
- ❌ "表现不错,给85分"（无因高分）

评分等级:
S(90-100)/A(75-89)/B(60-74)/C(45-59)/D(30-44)/F(<30)

### 第三部分：奖惩明细

#### 神点结算
基础神点 = 副本基础奖励 × 完成度系数
评价加成 = 基础神点 × (评分/100)
支线奖励 = 已完成支线的独立奖励累加
惩罚扣除 = 失败惩罚 + 队友损失惩罚
最终神点 = max(0, 基础 + 评价加成 + 支线 - 惩罚)

路径: add 轮回者.godPoints

#### 灵魂增长结算
本次灵魂增长 = 基础值 × 难度系数 × 评价系数 × 特殊事件乘数

基础值由副本难度决定:
D:10 | C:30 | B:80 | A:180 | S:380 | SS:900 | SSS:2000

难度系数:
完美通关:1.5 | 普通通关:1.0 | 勉强通关:0.3 | 失败但存活:0.1

评价系数:
评分/100（S级=0.9-1.0, A级=0.75-0.89 ...）

特殊事件乘数:
读取 当前副本.specialEvents 的 weight 值连乘
每个 weight 限制在 [0.8, 1.8] 区间

路径: add 轮回者.等级.soulStrength

#### 晋升资格点
资格点 = 副本评分 × 难度乘数(D:1/C:2/B:4/A:8/S:16/SS:32/SSS:64)
路径: add 轮回者.晋升.promotionPoints

### 第四部分：代价复盘
必须明确列出:
- 资源消耗:消耗品/弹药/特殊道具的净消耗
- 人员损失:队友伤亡/离队/背叛情况
- 状态变化:永久伤/debuff/精神创伤
- 关系影响:NPC好感度变化/新仇旧恨
- 隐患:未解决的威胁/埋下的伏笔

### 第五部分：成长标记
- 新获得的永久能力（副本内习得转为永久）
- 能力熟练度提升
- 属性变化（如果有结算奖励属性点）
- 等级/星级变化（灵魂增长后自动计算）

## 结算叙事风格
- 前半段以"主神系统结算播报"口吻：冷漠、精确、数据化
- 后半段切换为第三人称叙事：描写角色回到主神空间的画面与心理
- 总长度 500-800字

## 数据清理规则（结算 commands 必须执行）

### 归档副本记录
{"action":"push","key":"副本记录","value":{"missionId":"...","name":"...","difficulty":"...","worldType":"...","success":bool,"pointsGained":N,"soulGrowth":N,"rating":N,"finishedAt":"ISO8601","teamImpact":{"deathCount":N,"betrayCount":N},"summary":"一句话总结"}}

### 更新轮回者状态
{"action":"add","key":"轮回者.godPoints","value":最终神点}
{"action":"add","key":"轮回者.等级.soulStrength","value":灵魂增长}
{"action":"add","key":"轮回者.成长.missionCount","value":1}
{"action":"add","key":"轮回者.晋升.promotionPoints","value":资格点}

### 永久物品/能力转移
将 当前副本.临时状态 中标记为"可带出"的物品写入 轮回者.背包
将副本内习得的永久能力写入 轮回者.能力.已解锁能力

### 恢复状态
{"action":"set","key":"轮回者.vitals.HP.current","value":轮回者.vitals.HP.max}
{"action":"set","key":"轮回者.vitals.EP.current","value":轮回者.vitals.EP.max}
{"action":"set","key":"轮回者.vitals.MP.current","value":轮回者.vitals.MP.max}

### 清理副本数据
{"action":"set","key":"当前副本","value":null}
{"action":"set","key":"元数据.当前阶段","value":"hub"}

## 结算后行动选项（3-5 个）
- 查看详细结算报告
- 前往兑换大厅（花费新获得的神点）
- 与队友交流（复盘/处理队伍事务）
- 查看副本历史（回顾成长轨迹）
- 直接选择下一个副本

## 禁止行为
- 评价与过程事件不一致（无因高分/低分）
- 奖励/惩罚没有来源说明
- 跳过数据清理步骤（临时数据残留会污染后续副本）
- 结算中修改已完成的副本事件（事后篡改历史）
- 灵魂增长计算使用非公式方式（必须基于前端逻辑可验证的公式）
`.trim();
