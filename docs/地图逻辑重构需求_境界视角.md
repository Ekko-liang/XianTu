# 世界地图系统重构 PRD：境界视角分层地图

> **文档状态**: 设计确认，待实施  
> **最后更新**: 2026-02-23  
> **关联代码**: `src/utils/worldGeneration/`, `src/components/dashboard/GameMapPanel.vue`, `src/types/worldMap.ts`, `docs/save-schema-v3.md`

---

## 一、背景与问题

当前游戏采用单一大地图设计（默认 10000×10000 游戏坐标），所有境界的角色共用同一张地图，导致：

1. **沉浸感差**：练气期弟子看到的地图和渡劫期大能完全一样，大量"到不了"的遥远地点充斥地图，与角色处境严重割裂
2. **空旷感严重**：低阶角色 95% 的地图区域是无效死区，剩余可用空间丁点大
3. **通用性不足**：地图内容与角色起点信息（境界、出身、位置）无关，换个世界观设定就不适配

---

## 二、核心设计：境界地图集（Realm Map Collection）

### 2.1 设计原则

- **一境界一地图**：每个境界拥有一张完全独立生成的地图，独立坐标系，切换 Tab 如切换场景。有几个境界就最多有几张地图，不合并、不分组
- **境界无关通用性**：地图系统不感知任何具体境界名称，境界名称由角色数据动态传入，整套逻辑对任何境界体系均适配
- **角色信息驱动**：地图内容由玩家**当前境界 + 角色背景 + 已知 NPC 位置**决定，不对角色起点做任何假设
- **渐进解锁 + 手动生成**：高境界地图在境界突破时 Toast 提示，由用户手动决定何时生成
- **开关兼容旧模式**：通过功能开关支持新旧两种模式共存

### 2.2 地图的规模感知

**严格执行：1 个境界 = 1 张独立地图**，不合并、不分组。

提示词传入**当前境界名称**和**完整境界体系序列**，AI 根据该境界在体系中的具体位置自行判断合适的地图地理规模与内容密度，无需人为归类。

举例（一个有 10 个境界的世界）：

| 境界体系序列 | 对应地图（各自独立生成）           |
| ------------ | ---------------------------------- |
| 凡人         | 凡人地图（城镇/村落周边极小图）    |
| 练气期       | 练气期地图（比凡人稍大，仍为局部） |
| 筑基期       | 筑基期地图（扩展至大陆级）         |
| 金丹期       | 金丹期地图（大陆级，范围更广）     |
| 元婴期       | 元婴期地图（开始跨大陆）           |
| …            | …                                  |
| 大乘期       | 大乘期地图（全世界格局）           |

共 10 个境界 → 最多 10 张地图，每张相互独立。

### 2.3 完整地图层级结构

新体系下地图共分四层，与原有区域地图体系完全兼容：

```
境界地图（xx期地图）          ← 新增层，对应 世界.地图集["xx期"]
  └─ 地点（Location）         ← 现有：WorldInfo.地点信息[]
       └─ 区域地图（RegionMap） ← 现有：WorldInfo.区域地图[]，通过 linkedLocationId 绑定地点
            └─ 建筑（Building） ← 现有：RegionMap.buildings[]
```

**关键结论**：由于每个境界地图就是一个完整的 `WorldInfo`，而 `区域地图[]` 本身就存储在 `WorldInfo` 内，因此**区域地图天然跟随所属境界地图存储，无需额外改动存储结构**。

- 练气期地图的区域地图 → `世界.地图集["练气期"].区域地图[]`
- 筑基期地图的区域地图 → `世界.地图集["筑基期"].区域地图[]`
- 各境界地图的区域地图相互独立，不跨境界共享

### 2.4 Tab 切换设计

- **只展示已生成的地图**：Tab 列表动态来自 `世界.地图集` 的 key（即境界名称），没有"锁定"状态，未生成就不会出现
- **Tab 命名**：直接使用生成时的境界名称，如"练气期地图"、"筑基期地图"
- **当前 Tab**：默认选中与玩家当前境界最接近的已生成地图；切换后不自动跟随境界变化（用户手动切换）
- **生成入口**：地图界面顶部始终有"+ 生成当前境界地图"按钮，已生成的境界可通过"重新生成"更新

---

## 三、功能详细说明

### 3.1 开局地图生成

- **触发时机**：玩家完成角色创建后，第一次打开地图面板时，若当前境界的地图不存在，则展示生成提示
- **生成参数**：
  - 玩家当前境界名称 + 完整境界体系序列
  - 角色背景（出身、宗门隶属情况、位置）
  - 世界背景设定
  - 已有 NPC 的精简位置信息（可选，见 5.3）
- **适配场景举例**：
  - 凡人 → 生成以凡人城镇为中心的极小局部图
  - 已入宗的练气期 → 生成以宗门为核心的局部小图（含周边村镇）
  - 开局即金丹期 → 直接生成大陆级地图

### 3.2 境界突破后的提示

- 境界突破时，显示 **Toast 提示**："🗺️ 您的境界已提升，可以探索更广阔的世界了！前往地图生成【xxx期地图】"
- Toast 包含快捷跳转按钮；或仅文字提示，用户自行前往地图面板操作
- **不自动生成地图**，完全由用户决定

### 3.3 新境界地图生成

- 地图面板顶部 Tab 栏右侧有"+ 生成地图"按钮
- 点击后展示生成弹窗，可确认当前境界参数后开始生成
- 生成完成后，新 Tab 自动出现并激活

### 3.4 重新生成（对当前地图不满意）

- 每张地图 Tab 旁有"⟳ 重新生成"操作（或放在地图设置按钮内）
- 确认弹窗："重新生成将覆盖当前【xxx期地图】，已探索的地点记录也会丢失，确认吗？"
- 确认后重新生成，覆盖 `世界.地图集[境界名]`
- NPC 与该地图关联的位置坐标随之失效（弹窗中说明）

---

## 四、存档结构设计

### 4.1 功能开关

```
系统.设置: {
  境界分层地图: boolean   // 默认 false，关闭时保持旧单地图行为
}
```

> 该字段属于前端偏好设置，不发送给 AI，不影响叙事。

### 4.2 新增字段：地图集

在现有存档结构 `世界` 域下新增可选字段：

```
世界: {
  信息: WorldInfo,              // ✅ 保留（旧模式使用 / 新模式 fallback）
  地图集?: {                    // ✅ 新增，开关开启时使用
    [realmName: string]: WorldInfo
    // 例：
    // "练气期": WorldInfo,
    // "筑基期": WorldInfo,
  }
}
```

`WorldInfo` 结构**完全复用**现有定义，无需修改内部字段。

### 4.3 地点信息扩展

每个地点条目新增可选字段：

```typescript
interface WorldLocation {
  // 现有字段（完全保留）...

  // 新增可选字段
  targetRealm?: string // 该地点所属的境界地图（与地图集 key 对应）
}
```

### 4.4 兼容性矩阵

| 场景                    | 行为                                                             |
| ----------------------- | ---------------------------------------------------------------- |
| 旧存档 + 开关关闭       | `世界.信息` 正常使用，完全不变                                   |
| 旧存档 + 开关打开       | 自动将 `世界.信息` 导入 `地图集[当前境界名]`，原 `信息` 保留不动 |
| 新存档 + 开关关闭       | 按旧模式生成一张大地图，写入 `世界.信息`                         |
| 新存档 + 开关打开       | 按角色境界生成初始地图，写入 `世界.地图集[当前境界名]`           |
| `地图集` 某境界地图缺失 | 显示"尚未生成此境界地图"入口，不报错                             |

> **不做强制迁移**：开关是用户主动选择，旧存档旧行为完全向后兼容。

---

## 五、提示词改造方案（重点）

这是改造量最大的模块。现有提示词假设生成"完整大世界"格式，需改为**境界感知格式**。

### 5.1 新增提示词入口

在 `EnhancedWorldPromptBuilder` 中新增 `buildRealmMapPrompt()` 方法，供新模式调用：

```typescript
interface RealmMapPromptConfig {
  // 角色信息
  playerRealm: string // 当前境界名称，如 "筑基期"
  playerRealmContext: string // 完整境界体系序列，如 "凡人→练气期→筑基期→金丹期→..."
  playerBackground: string // 角色出身背景
  playerFaction?: string // 所属宗门/势力（可无）
  playerLocation?: string // 已知位置描述

  // 世界信息
  worldName?: string
  worldBackground?: string
  worldEra?: string

  // NPC 位置上下文（可选）
  npcHints?: NpcLocationHint[] // 见 5.3

  // 地图配置
  mapConfig?: WorldMapConfig
}
```

### 5.2 提示词规模自适应

提示词核心改动：**移除硬编码的大陆/势力/地点数量配置，不做低/中/高段分组**，改为直接传入当前境界及完整体系序列，由 AI 完全按该境界的实际含义自主决定规模。

提示词关键段落示意：

```
## 地图生成任务 - 【{playerRealm}】境界视角

当前玩家境界：{playerRealm}
本世界完整境界体系（按修炼顺序排列）：{playerRealmContext}
  示例：凡人 → 练气期 → 筑基期 → 金丹期 → 元婴期 → 化神期 → ...

角色背景：{playerBackground}
所属势力/宗门：{playerFaction 或 "无"}
已知所在位置：{playerLocation 或 "未知"}
世界设定：{worldBackground}

## 🎯 核心生成要求

请为处于【{playerRealm}】境界的角色，生成一张该境界专属的世界地图。

核心原则：
- 参考上方境界体系序列，理解【{playerRealm}】处于整个体系的哪个阶段
- 根据该境界修士实际能到达和感知的范围，自主决定地图的地理规模和内容密度
- 地点数量、势力数量、大陆数量均不做硬性规定，由你自主判断，确保内容与该境界相称
- 越早期的境界，地图越聚焦于局部区域；越高阶的境界，地图越宏观
- 此地图仅代表【{playerRealm}】境界角色所能认知和涉足的世界范围，不是全世界地图
```

### 5.3 NPC 位置上下文（可选传入）

生成境界地图时，可将**已有 NPC 的精简信息**作为参考上下文传入，帮助 AI 将地图中的地点与已知 NPC 的位置关联，避免"换张地图后 NPC 位置陌生"的问题。

**传入字段**（仅 3 个字段，不传记忆/好感/属性）：

```typescript
interface NpcLocationHint {
  名字: string // NPC 姓名
  境界: string // NPC 当前境界
  当前位置: string // NPC 位置描述，如 "青云宗外门区"
}
```

**Token 估算**：10 个 NPC × 3 字段 ≈ +200 token，完全可接受。

**不传记忆**：记忆条目数量不稳定且对地图坐标生成帮助有限，暂不传入。

**配置控制**：`RealmMapPromptConfig.npcHints` 为可选字段，调用方决定是否填充；默认**开启**（从 `社交.关系` 中自动摘取已有 NPC 的姓名+境界+位置描述）。

### 5.4 旧提示词保留

现有 `buildPrompt()` 方法完全保留，供"开关关闭"的旧模式继续使用，不影响现有用户。

---

## 六、UI 改造要点（`GameMapPanel.vue`）

| 改动         | 说明                                                                            |
| ------------ | ------------------------------------------------------------------------------- |
| 顶部 Tab 栏  | 根据 `世界.地图集` 的 key 动态渲染 Tab，每个 Tab = 一个境界地图；旧模式下无 Tab |
| Tab 右侧操作 | "⟳ 重新生成"（覆盖当前境界地图）                                                |
| Tab 栏末尾   | "+ 生成当前境界地图"按钮，点击触发新境界地图生成                                |
| 初始生成逻辑 | 判断当前境界地图是否存在，不存在则展示生成引导                                  |
| 地图内容渲染 | 当前激活 Tab 的 `WorldInfo` 传入渲染逻辑（复用现有 Pixi.js 渲染）               |
| 旧模式       | 开关关闭时无 Tab，直接用 `世界.信息` 渲染，行为与现在完全一致                   |

---

## 七、境界突破联动

境界突破的 Toast 提示需要在叙事系统或境界变化监听处挂载，具体位置待代码阶段确认。

提示文案示例：

```
🗺️ 境界突破！您已晋升【筑基期】，视野更加宏观。
前往地图面板，探索更广阔的世界吧！
```

---

## 八、实施优先级

| 优先级 | 模块       | 任务                                                                   | 难度 |
| ------ | ---------- | ---------------------------------------------------------------------- | ---- |
| P0     | 存档       | 新增 `世界.地图集` 和 `系统.设置.境界分层地图` 字段定义及读写          | 低   |
| P0     | UI         | `GameMapPanel.vue`：Tab 栏动态渲染 + 切换逻辑                          | 中   |
| P0     | 提示词     | `enhancedWorldPrompts.ts`：新增 `buildRealmMapPrompt()` 境界感知提示词 | 高   |
| P0     | 生成器     | `enhancedWorldGenerator.ts`：新增 `RealmMapGenConfig`，调用新提示词    | 中   |
| P1     | UI         | 重新生成功能 + 确认弹窗                                                | 低   |
| P1     | UI         | 旧存档自动迁移（开关开启时将 `世界.信息` 导入地图集）                  | 低   |
| P2     | 系统       | 境界突破 Toast 提示联动                                                | 中   |
| P3     | 地点定位器 | `locationPlacementGenerator.ts` 动态添加地点时写入 `targetRealm`       | 低   |

---

## 九、区域地图关联影响盘点

在新体系下，区域地图的核心代码（`regionMapGenerator.ts`、`RegionMapPanel.vue`）**无需改动生成逻辑**，但有以下关联点需要处理：

### 9.1 区域地图的读写路径变化

| 场景                       | 旧路径                         | 新路径（开关开启时）                          |
| -------------------------- | ------------------------------ | --------------------------------------------- |
| 读取区域地图列表           | `世界.信息.区域地图[]`         | `世界.地图集[activRealm].区域地图[]`          |
| 写入新区域地图             | `世界.信息.区域地图.push(...)` | `世界.地图集[activeRealm].区域地图.push(...)` |
| 按 `linkedLocationId` 查找 | 从 `世界.信息.区域地图` 中查   | 从当前激活的境界地图的 `区域地图` 中查        |

**需要改动**：`GameMapPanel.vue` 中"进入区域地图"按钮触发的读写逻辑，需根据当前激活 Tab 的境界名定位到正确的 `WorldInfo`。

### 9.2 区域地图的作用域与生命周期

- 区域地图属于**生成它时所在的境界地图**，随境界地图独立存在
- 当用户对某个境界地图执行**重新生成**时，该境界地图下所有区域地图一并清除（地点被重建），可在弹窗中提示
- 跨境界地图没有共享区域地图的需求（各境界的地点本就不同）

### 9.3 NPC 位置与区域地图的关联

NPC 的 `当前位置` 存储了 `regionId`（区域地图 ID）和 `buildingId`（建筑 ID）：

```typescript
当前位置: {
  描述: string
  x?: number
  y?: number
  regionId?: string    // 所在区域地图 ID
  buildingId?: string  // 所在建筑 ID
}
```

当某个境界地图重新生成时，该地图下的区域地图 ID 会变化，导致 NPC 的 `regionId` 失效。**处理建议**：重新生成弹窗中明确告知"NPC 的精确建筑位置将失效，仅保留文字位置描述"，NPC 位置描述字段（`描述`）不受影响。

### 9.4 `locationPlacementGenerator.ts` 的影响

当 NPC 触发"未收录地点"逻辑时，该生成器会将新地点写入 `世界.信息.地点信息`（旧路径）。

**需要改动**：在新模式下需写入当前激活境界地图的 `地点信息[]`，即 `世界.地图集[activeRealm].地点信息`。同时新地点写入时，`区域地图` 生成（首次进入区域触发）也需要写入对应境界地图下。

### 9.5 `RegionMapPanel.vue` 无需修改

区域地图面板组件本身接收 `regionMap` prop 渲染，不直接依赖 `世界.信息`，改动只在上层调用方（`GameMapPanel.vue`）中完成路径切换即可。

---

- 地图 fog-of-war（迷雾探索）
- 联机模式下的地图集同步
- 地图内地点的"探索状态"记录
- 不同境界地图间的地点坐标空间关联（各地图独立）
